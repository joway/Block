---
title: HexoæŠ˜è…¾è®°â€”â€”ç»ˆæåŠ é€Ÿ:å…¨çº¿æ¥å…¥CDN
comments: true
categories: Hexo
tags:
	- hexo
	- å‰ç«¯
	- blog
	- ä¸ƒç‰›
	- CDN
	- åŠ é€Ÿ
---


å‰æ®µæ—¶é—´ä¸€ä¸å°å¿ƒçœ‹åˆ°äº†ä¸ƒç‰›æ”¯æŒHTTPSè¯ä¹¦å¯¼å…¥ï¼Œå°±æƒ³å»è¯•è¯•æŠŠåšå®¢å…¨çº¿æ¥å…¥CDN(å•Šï¼Œè¯´å¥½çš„å¥½å¥½è¯»ä¹¦ä¸æŠ˜è…¾åšå®¢äº†å‘¢ ? ğŸ˜‚)ï¼Œä¸è¿‡ä¸ƒç‰›è¿™è´§ä¹Ÿæ˜¯å‘ï¼Œå…‰æ˜¯è¯ä¹¦å½•å…¥å°±èŠ±äº†å¿«ä¸€ä¸ªæ˜ŸæœŸï¼Œå®Œäº†ä»¥åæˆ‘æ”¹ä¸ªæºç«™åˆæ˜¯å¥½å‡ å¤©ï¼Œæœ€åæ”¹ä¸ªç¼“å­˜ç­–ç•¥åˆè¦ç­‰ã€‚ä¸¥é‡æ€€ç–‘ä¸ƒç‰›çº¯ç²¹æ˜¯æ‰‹åŠ¨æ¥æè¿™äº›ä¸œè¥¿ã€‚ã€‚ã€‚åŒæ ·çš„ä¸œè¥¿ï¼Œåˆæ‹äº‘å°±åˆ†åˆ†é’Ÿç”Ÿæ•ˆå®Œæˆã€‚

<!--more-->

ä¸Šä¸€ç¯‡æ–‡ç« é‡Œæˆ‘è®²äº†å› ä¸ºè½½å…¥çš„èµ„æºå¤ªå¤šï¼Œæˆ‘ç”¨æ’ä»¶æŠŠjs,csså…¨éƒ¨å†…è”äº†ï¼Œä½†æ˜¯å¦‚æœæ¥å…¥äº†CDNåï¼Œé¦–å…ˆç”±äºç¼“å­˜çš„åŸå› ï¼Œæˆ‘ä¸èƒ½å¤ŸæŠŠhtmlç»™ç¼“å­˜å¤ªé•¿æ—¶é—´ï¼Œå¦åˆ™æˆ‘æ›´æ–°ä¸€ç¯‡æ–‡ç« åœ¨å®¢æˆ·ç«¯ç”Ÿæ•ˆå¾—ç­‰å¥½é•¿æ—¶é—´ï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœæˆ‘å…¨éƒ¨å†…è”ï¼Œç›¸å½“äºå¤§éƒ¨åˆ†èµ„æºéƒ½æœ‰å»ç¼“å­˜ï¼Œè™½ç„¶CDNä»æ—§èƒ½å¤Ÿä»¥å…¶é€Ÿåº¦ä¼˜åŠ¿æ¥å¼¥è¡¥å•ä¸ªæ–‡ä»¶è¿‡å¤§çš„ç¼ºé™·ï¼Œä½†æ˜¾ç„¶è¿™ç§åšæ³•è¿˜æ˜¯ä¸å¤Ÿé«˜æ•ˆã€‚

ç”±äºæˆ‘å¹¶ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šå…¨éƒ¨å†…è”å‡å°‘è¯·æ±‚æ¬¡æ•°ï¼Œä¸å‡å°å•ä¸ªæ–‡ä»¶ä½“ç§¯ä¸¤ç§åšæ³•ä¹‹é—´å…·ä½“çš„æ€§èƒ½å·®å¼‚ï¼Œæ‰€ä»¥æˆ‘ä¸¤ç§æ–¹å¼éƒ½éƒ¨ç½²äº†ä¸€éï¼Œæœ€åä»"æ‰‹æ„Ÿ"ä¸Šåˆ¤æ–­åä¸€ç§æ–¹æ³•ä¼¼ä¹å“åº”æ›´åŠ è¿…é€Ÿã€‚ä¹‹æ‰€ä»¥è¯´"æ‰‹æ„Ÿ"ï¼Œæ˜¯å› ä¸ºæœ‰å¥½å¤šæ¬¡æˆ‘éƒ½å‘ç°æ˜æ˜æ•°æ®å¾ˆå¥½çœ‹ï¼Œä½†æ˜¯å®é™…æµè§ˆå™¨è®¿é—®çš„æ—¶å€™è¿˜æ˜¯æ„Ÿè§‰å¾ˆæ…¢ï¼ŒåŠ è½½ä¹Ÿä¸æµç•…ã€‚è€Œæ¥å…¥ä¸ƒç‰›CDNåï¼Œè™½ç„¶æ•°æ®ä¸Šä¸æ€ä¹ˆå¥½çœ‹ï¼Œæœ‰æ—¶å€™ç”šè‡³ä¼šæœ‰10ç§’ä»¥ä¸Šçš„åŠ è½½æ—¶é—´ï¼Œä½†æ˜¯çš„ç¡®å“åº”ä¸Šæµç•…å¤šäº†ï¼Œç›®å‰æˆ‘è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šè¿™ç§å·®å¼‚æ˜¯ç”±äºä»€ä¹ˆã€‚

æ¥å…¥ä¸ƒç‰›CDNçš„è¿‡ç¨‹éå¸¸ç®€å•ï¼Œé¦–å…ˆï¼Œå†™ä¸ªè„šæœ¬æ¯æ¬¡åœ¨æ„å»ºçš„æ—¶å€™ä¸Šä¼ publicç›®å½•è‡³ä¸ƒç‰›ï¼Œç„¶ååœ¨ä¸ƒç‰›é‚£è¾¹ï¼Œé…ç½®ä¸€ä¸ªhttpsçš„è¯ä¹¦ï¼Œç”±äºæˆ‘åªæ˜¯ä¸ªåšå®¢ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§çš„å®‰å…¨éœ€æ±‚ï¼Œæä¸ªhttpsçº¯ç²¹ä¸ºäº†é˜²åŠ«æŒå’Œè£…é€¼ï¼Œæ‰€ä»¥æˆ‘å¾ˆå¼€å¿ƒåœ°å°±æŠŠç§é’¥ä¸Šä¼ ä¸Šå»äº†(ğŸ˜‚ï¼‰. å»ºè®®åœ¨ä¸Šä¼ å‰å°±åšå¥½æºç«™é…ç½®å’Œç¼“å­˜ç­–ç•¥ï¼Œå¦åˆ™ï¼Œæ¯æ¬¡æ›´æ”¹éƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ç­‰å¾…ã€‚

å…³äºä¸Šä¼ è„šæœ¬ï¼Œå¯ä»¥ç”¨æˆ‘å†™çš„python ä¸Šä¼ è„šæœ¬ï¼Œä¹Ÿå¯ä»¥ç”¨gulpçš„ä¸€ä¸ªæ’ä»¶: [gulp-qiniu](https://github.com/hfcorriez/gulp-qiniu)

æ³¨æ„ï¼Œä¸ƒç‰›è‡ªèº«ä¸æ”¯æŒç›®å½•ï¼Œè€Œæ˜¯ä»¥æ–‡ä»¶å‰ç¼€çš„å½¢å¼æ¥æŒ‡å®šæ–‡ä»¶è·¯ç»ï¼Œæ‰€ä»¥åœ¨ä¸Šä¼ çš„æ—¶å€™è¦æŠŠè·¯å¾„æŒ‡å®šå¥½ã€‚

PS: ä¸ƒç‰›HTTPSå¼„å¥½åï¼Œéœ€è¦æŠŠCDNé…åˆ°ä¸ƒç‰›ä¸Šå»ï¼Œç„¶è€Œæˆ‘ç”¨çš„cloudxnsæ— æ³•è®©mxè®°å½•å’Œcnameè®°å½•åœ¨@ä¸‹å…±å­˜ã€‚æŸ¥é˜…äº†cloudxnsçš„è§£é‡Šåï¼Œæ‰å‘ç°ä¹‹å‰æˆ‘ä¸€ç›´åœ¨dnspodä¸Šä¸¤ä¸ªä¸€èµ·è®¾ç½®ï¼Œæ˜¯æœ‰å¯èƒ½å¯¼è‡´æˆ‘çš„åŸŸåé‚®ç®±ä¸¢ä»¶çš„ã€‚cloudxnsä¸ºè¿™ç§æƒ…å†µæä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆ: ç”¨ www.joway.wang åŸŸåcname åˆ° ä¸ƒç‰›ä¸Šï¼Œç„¶åjoway.wang ç”¨ link è®°å½•åˆ°www.joway.wang ä¸Šã€‚è¿™æ ·å°±è§£å†³äº†é—®é¢˜ï¼Œè™½ç„¶æˆ‘æ²¡çœ‹æ‡‚linkè®°å½•æ˜¯ä¸ªä»€ä¹ˆé¬¼ã€‚ã€‚


ä¸Šä¼ ç›®å½•çš„Python è„šæœ¬å¦‚ä¸‹: 

``` python
import os
import sys
from easy_qiniu import SevenCow

prefix_dir = sys.path[0]+'/public'

#å¯è·å–æ–‡ä»¶å¤¹å†…å…¨éƒ¨æ–‡ä»¶å(åŒ…æ‹¬å­æ–‡ä»¶å¤¹)
def get_all_files(DirectoryPath):
    filenamesList = []
    for dirpath, dirnames, filenames in os.walk(DirectoryPath):
        """
        dirpathï¼šå½“å‰éå†æ–‡ä»¶å¤¹å…¨å
        dirnamesï¼šå½“å‰æ–‡ä»¶å¤¹å†…å­æ–‡ä»¶å¤¹å
        filenamesï¼šå½“å‰æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶ååˆ—è¡¨(ä¸åŒ…æ‹¬å­æ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶)
        """
        for filename in filenames:
            filenamesList.append(dirpath + '/' + filename)#å…¨å
    return filenamesList


#ç”Ÿæˆç½‘ç«™æ ¹ç›®å½•å½¢å¼çš„æ–‡ä»¶å
def get_root_filename(fullname):
    dir_path = sys.path[0]
    return fullname[len(prefix_dir) + 1:len(fullname)].replace('\\','/')

#ç”Ÿæˆ{ç›®æ ‡æ–‡ä»¶å:æºæ–‡ä»¶å,...}å½¢å¼çš„å­—å…¸
def get_filenames_dict(filenamesList=[]):
    filenames_dict = {}
    for filename in filenamesList:
        filenames_dict[get_root_filename(filename)] = filename
    return filenames_dict

#ä¸Šä¼ ï¼Œæ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦æˆåŠŸ
def upload_into_qiniu(access_key,secret_key,bucket_name,director_path=sys.path[0]):
    try:
        sc = SevenCow(access_key,secret_key)
        sc.delete_files(bucket_name,sc.list_file_names(bucket_name)[0])
        print('Delete Successful')
        sc.upload_files(bucket_name,get_filenames_dict(get_all_files(director_path)))
    except:
        return False
    else:
        return True

access_key = ''
secret_key = ''
bucket_name = 'hexo-blog'
if(upload_into_qiniu(access_key,secret_key,bucket_name, director_path=prefix_dir)):
    print('Bak Successful')
else:
    print('Bak Error')
```



easy_qiniu.py:

``` python 
from qiniu import  Auth
from qiniu import put_file
from qiniu import BucketManager
from qiniu import build_batch_stat
from qiniu import build_batch_copy
from qiniu import build_batch_move
from qiniu import build_batch_delete
from qiniu import etag

import requests
import mimetypes


#class SevenCowException(Exception):
#    def __init__(self,status_code,content):
#        self.url = url
#        self.status_code = status_code
#        self.content = content
#        Exception.__init__(self, content)

class SevenCow(object):
    def __init__(self, access_key,secret_key):
        self.__access_key = access_key
        self.__secret_key = secret_key
        #ä½¿ç”¨access_key,secret_keyç™»é™†ä¸ƒç‰›ï¼Œå¾—åˆ°Authç±»å‹è¿”å›å€¼ï¼Œä»¥å®ƒä½œä¸ºåç»­æ“ä½œå‡­è¯
        self.__auth = Auth(access_key, secret_key)

        

    # ä¸Šä¼ æœ¬åœ°æ–‡ä»¶(æ–­ç‚¹ç»­ä¸Šä¼ ã€åˆ†å—å¹¶è¡Œä¸Šä¼ )
    def upload_files(self,bucket_name='',filedict={},
                     mime_type='',params={'x:a': 'a'}):
        """Args:
        bucket_name:'bucket_name'
        filedict: {'key':'localfile',...}
        mime_type: mime_type
        params: eg {'x:var': 'var'} 
        """

        """
        paramsç”¨æ³•:
        params={'x:price':'price','x:location':'location'}
        """
        # ä¸Šä¼ æœ¬åœ°æ–‡ä»¶(æ–­ç‚¹ç»­ä¸Šä¼ ã€åˆ†å—å¹¶è¡Œä¸Šä¼ )
        rets = []
        infos = []
        for key in filedict.keys():
            #ä¸Šä¼ ç­–ç•¥ä»…æŒ‡å®šç©ºé—´åå’Œä¸Šä¼ åçš„æ–‡ä»¶åï¼Œå…¶ä»–å‚æ•°ä¸ºé»˜è®¤å€¼
            token = self.__auth.upload_token(bucket_name, key)
            progress_handler = lambda progress, total: progress
            if(mime_type == ''):
                ret,info = put_file(token, key, filedict[key], params ,mime_type=mimetypes.guess_type(key)[0], progress_handler=progress_handler)
            else:
                ret,info = put_file(token, key, filedict[key], params ,mime_type=mime_type, progress_handler=progress_handler)
            #assert ret['key'] == key
            rets.append(ret)
            infos.append(info)
        return rets,infos


    def download_files(self,url='',filedict={}):
        """Args:
        url: 'url'
        filedict: {'key':'localfile',...}
        """
        if(url[0:4].upper() != 'HTTP'):
            url = 'http://' + url
        status_codes = []
        for fkey in filedict.keys():
            with open(filedict[fkey], "wb") as file:
                r = requests.get(url + '/' + fkey,timeout=5)
                status_codes.append(r.status_code)
                file.write(r.content)
        return status_codes


    # è·å–æ–‡ä»¶ä¿¡æ¯
    def get_file_info(self,bucket_name,keys=[]):
        """Args:
        bucket_name:'bucket_name'
        keys:  ['fileName1','fileName2']
        """
        bucket = BucketManager(self.__auth)
        ops = build_batch_stat(bucket_name, keys)
        ret, info = bucket.batch(ops)
        return ret,info


    # å¤åˆ¶æ–‡ä»¶
    def copy_files(self,source_bucket,target_bucket,pathdict={}):
        """Args:
        source_bucketï¼š 'source_bucket'
        target_bucket:  'target_bucket'
        pathdict: {'source_file_name':'target_file_name',...}
        """
        bucket = BucketManager(self.__auth)
        ops = build_batch_copy(source_bucket, pathdict, target_bucket)
        ret, info = bucket.batch(ops)
        return ret,info


    # ç§»åŠ¨æ–‡ä»¶
    def move_files(self,source_bucket,target_bucket,pathdict={}):
        """Args:
        source_bucketï¼š 'source_bucket'
        target_bucket:  'target_bucket'
        pathdict: {'source_file_name':'target_file_name',...}
        """
        bucket = BucketManager(self.__auth)
        ops = build_batch_move(source_bucket, pathdict, target_bucket)
        ret, info = bucket.batch(ops)
        return ret,info


    # åˆ é™¤æ–‡ä»¶
    def delete_files(self,source_bucket,pathlist=[]):
        """Args:
        source_bucketï¼š 'source_bucket'
        pathlist: ['source_file_name',...]
        """
        bucket = BucketManager(self.__auth)
        ops = build_batch_delete(source_bucket, pathlist)
        ret, info = bucket.batch(ops)
        return ret,info

    # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
    def list_file_names(self,bucket_name, prefix=None, marker=None, limit=None, delimiter=None):
        """
        Args:
            bucket:     ç©ºé—´å
            prefix:     åˆ—ä¸¾å‰ç¼€
            marker:     åˆ—ä¸¾æ ‡è¯†ç¬¦(é¦–æ¬¡ä¸ºNone)
            limit:      å•æ¬¡åˆ—ä¸¾ä¸ªæ•°é™åˆ¶(é»˜è®¤åˆ—ä¸¾å…¨éƒ¨)
            delimiter:  æŒ‡å®šç›®å½•åˆ†éš”ç¬¦
            
        Returns:
            pathlist: ['file_name',...]
        """
        file_name_list = []
        bucket = BucketManager(self.__auth)
        marker = None
        eof = False
        while eof is False:
            ret, eof, info = bucket.list(bucket_name, prefix=prefix, marker=marker, limit=limit)
            marker = ret.get('marker', None)
            for item in ret['items']:
                file_name_list.append(item['key'])
        return file_name_list,eof

    # æŠ“å–èµ„æº
    def fetch_files_from_net_to_qiniu(self,bucket_name,pathdict={}):
        """Args:
        bucket_nameï¼š 'bucket_name'
        pathdict: {'source_file_name':'target_file_name',...}
        """
        bucket = BucketManager(self.__auth)
        rets=[]
        infos=[]
        for p in pathdict.keys():
            ret, info = bucket.fetch(pathdict[p], bucket_name,p)
            rets.append(ret)
            infos.append(info)
        return rets,infos

    # æ›´æ–°é•œåƒèµ„æº
    def update_image_source(self,bucket_name,pathlist=[]):
        """Args:
        bucket_nameï¼š 'bucket_name'
        pathlist: ['file_name',...]
        !éœ€è¦æå‰å¯¹ä»“åº“è®¾ç½®é•œåƒæº!
        """

        bucket = BucketManager(self.__auth)
        rets=[]
        infos=[]
        for p in pathlist:
            ret, info = bucket.prefetch(bucket_name, p)
            rets.append(ret)
            infos.append(info)
        return rets,infos
```